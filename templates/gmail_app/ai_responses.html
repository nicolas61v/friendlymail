{% extends 'base.html' %}

{% block content %}
{% if not has_ai_config %}
    <div class="card text-center">
        <h2>ü§ñ Configure AI Assistant First</h2>
        <p>You need to set up your AI context before managing responses.</p>
        <a href="{% url 'ai_config' %}" class="btn btn-primary">üîß Configure AI Assistant</a>
    </div>
{% else %}
    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'process_existing_emails' %}" class="btn btn-primary">
            ü§ñ Process Existing Emails with AI
        </a>
        <a href="{% url 'ai_config' %}" class="btn btn-secondary">
            ‚öôÔ∏è Configure AI
        </a>
        <button class="btn btn-warning" onclick="debugAI()">
            üêõ Debug AI Status
        </button>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ pending_responses|length }}</h3>
            <p>Pending Approval</p>
            <span class="stat-icon">‚è≥</span>
        </div>
        <div class="stat-card">
            <h3>{{ recent_responses|length }}</h3>
            <p>Recent Responses</p>
            <span class="stat-icon">üì§</span>
        </div>
        <div class="stat-card">
            <h3>{{ email_intents|length }}</h3>
            <p>Emails Analyzed</p>
            <span class="stat-icon">üß†</span>
        </div>
        <div class="stat-card">
            <h3>{% if ai_context.auto_send %}Auto{% else %}Manual{% endif %}</h3>
            <p>Send Mode</p>
            <span class="stat-icon">{% if ai_context.auto_send %}‚ö°{% else %}üë§{% endif %}</span>
        </div>
    </div>

    <!-- Pending Approvals -->
    {% if has_pending %}
        <div class="card">
            <h2>‚è≥ Pending Approvals</h2>
            <p>These AI-generated responses are waiting for your approval before sending.</p>
            
            <div class="responses-grid">
                {% for response in pending_responses %}
                    <div class="response-card pending">
                        <div class="response-header">
                            <div class="email-info">
                                <h4>{{ response.email_intent.email.subject|truncatechars:50 }}</h4>
                                <p class="email-meta">
                                    <strong>From:</strong> {{ response.email_intent.email.sender }}<br>
                                    <strong>Intent:</strong> {{ response.email_intent.get_intent_type_display }}
                                    <span class="confidence">({{ response.email_intent.confidence_score|floatformat:2 }})</span>
                                </p>
                            </div>
                            <div class="response-status">
                                <span class="status-badge status-pending">Pending</span>
                            </div>
                        </div>
                        
                        <div class="response-content">
                            <h5>AI Generated Response:</h5>
                            <div class="response-text">{{ response.response_text|linebreaks }}</div>
                        </div>
                        
                        <div class="response-actions">
                            <a href="{% url 'approve_response' response.id %}" class="btn btn-success">
                                ‚úÖ Approve & Send
                            </a>
                            <button class="btn btn-danger" onclick="showRejectForm({{ response.id }})">
                                ‚ùå Reject
                            </button>
                            <button class="btn btn-secondary" onclick="toggleOriginalEmail({{ response.id }})">
                                üëÅÔ∏è View Original
                            </button>
                        </div>
                        
                        <!-- Original Email (Initially Hidden) -->
                        <div id="original-{{ response.id }}" class="original-email" style="display: none;">
                            <h5>Original Email:</h5>
                            <div class="email-content">{{ response.email_intent.email.body_plain|linebreaks|truncatechars:500 }}</div>
                        </div>
                        
                        <!-- Reject Form (Initially Hidden) -->
                        <div id="reject-form-{{ response.id }}" class="reject-form" style="display: none;">
                            <form method="post" action="{% url 'reject_response' response.id %}">
                                {% csrf_token %}
                                <h5>Why are you rejecting this response?</h5>
                                <textarea name="feedback" placeholder="Optional feedback to improve AI responses..." rows="3"></textarea>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-danger">Confirm Reject</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideRejectForm({{ response.id }})">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- Recent Activity Tabs -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('responses')">üì§ Recent Responses</button>
            <button class="tab-button" onclick="switchTab('analysis')">üß† Email Analysis</button>
        </div>
    </div>
    
    <!-- Recent Responses Tab -->
    <div id="responses-tab" class="tab-content active">
        <div class="card">
            <h2>üì§ Recent AI Responses</h2>
            
            {% if recent_responses %}
                <div class="table-container">
                    <table class="responses-table">
                        <thead>
                            <tr>
                                <th>Email Subject</th>
                                <th>Sender</th>
                                <th>Status</th>
                                <th>Generated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for response in recent_responses %}
                                <tr>
                                    <td>
                                        <div class="email-subject">{{ response.email_intent.email.subject|truncatechars:40 }}</div>
                                        <small class="email-intent">{{ response.email_intent.get_intent_type_display }}</small>
                                    </td>
                                    <td>{{ response.email_intent.email.sender|truncatechars:30 }}</td>
                                    <td>
                                        <span class="status-badge status-{{ response.status }}">
                                            {% if response.status == 'sent' %}‚úÖ Sent
                                            {% elif response.status == 'approved' %}üëç Approved
                                            {% elif response.status == 'rejected' %}‚ùå Rejected
                                            {% elif response.status == 'pending_approval' %}‚è≥ Pending
                                            {% else %}{{ response.get_status_display }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>{{ response.generated_at|timesince }} ago</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewResponse({{ response.id }})">
                                            üëÅÔ∏è View
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>üì≠ No Responses Yet</h3>
                    <p>AI responses will appear here once you start processing emails.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Email Analysis Tab -->
    <div id="analysis-tab" class="tab-content">
        <div class="card">
            <h2>üß† Email Analysis</h2>
            <p>See how AI is analyzing and categorizing your incoming emails.</p>
            
            {% if email_intents %}
                <div class="analysis-grid">
                    {% for intent in email_intents %}
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <h4>{{ intent.email.subject|truncatechars:40 }}</h4>
                                <span class="confidence-score">{{ intent.confidence_score|floatformat:2 }}</span>
                            </div>
                            
                            <div class="analysis-details">
                                <p><strong>From:</strong> {{ intent.email.sender|truncatechars:30 }}</p>
                                <p><strong>Intent:</strong> {{ intent.get_intent_type_display }}</p>
                                <p><strong>Decision:</strong> 
                                    <span class="decision decision-{{ intent.ai_decision }}">
                                        {% if intent.ai_decision == 'respond' %}ü§ñ AI Respond
                                        {% elif intent.ai_decision == 'escalate' %}üë§ Human Review  
                                        {% else %}üö´ Ignore
                                        {% endif %}
                                    </span>
                                </p>
                                
                                {% if intent.matched_rule %}
                                    <p><strong>Rule:</strong> {{ intent.matched_rule.name }}</p>
                                {% endif %}
                                
                                <p><strong>Reason:</strong> {{ intent.decision_reason|truncatechars:80 }}</p>
                                <p><strong>Processed:</strong> {{ intent.processed_at|timesince }} ago</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>üîç No Analysis Yet</h3>
                    <p>Email analysis will appear here once you sync emails with AI processing enabled.</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}

<script>
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
}

function toggleOriginalEmail(responseId) {
    const element = document.getElementById('original-' + responseId);
    element.style.display = element.style.display === 'none' ? 'block' : 'none';
}

function showRejectForm(responseId) {
    document.getElementById('reject-form-' + responseId).style.display = 'block';
}

function hideRejectForm(responseId) {
    document.getElementById('reject-form-' + responseId).style.display = 'none';
}

function viewResponse(responseId) {
    // Find the response in the table and show details
    const row = document.querySelector(`button[onclick="viewResponse(${responseId})"]`).closest('tr');
    const subject = row.cells[0].textContent.trim();
    const sender = row.cells[1].textContent.trim();
    const status = row.cells[2].textContent.trim();
    
    // For now, show a simple alert with info
    // TODO: Implement proper modal with full response text
    alert(`üìß Response Details:\n\nEmail: ${subject}\nFrom: ${sender}\nStatus: ${status}\n\nNote: Full response modal coming soon!`);
}

function debugAI() {
    fetch('/debug/ai-status/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const info = data.debug_info;
                let message = `ü§ñ AI Debug Info:\n\n`;
                
                message += `AI Context: ${info.ai_context.exists ? 'EXISTS' : 'NOT FOUND'}\n`;
                if (info.ai_context.exists) {
                    message += `- Active: ${info.ai_context.is_active}\n`;
                    message += `- Role: ${info.ai_context.role}\n`;
                    message += `- Has Description: ${info.ai_context.has_description}\n`;
                    message += `- Auto Send: ${info.ai_context.auto_send}\n`;
                }
                
                message += `\nEmails:\n`;
                message += `- Total: ${info.emails.total}\n`;
                message += `- Processed by AI: ${info.emails.processed_by_ai}\n`;
                message += `- Unprocessed: ${info.emails.unprocessed}\n`;
                
                message += `\nAI Responses: ${info.responses}\n`;
                message += `Temporal Rules: ${info.temporal_rules}\n`;
                message += `OpenAI Configured: ${info.openai_configured}\n`;
                
                alert(message);
            } else {
                alert('Error getting debug info: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error fetching debug info: ' + error);
        });
}
</script>

<style>
.quick-actions {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    justify-content: center;
    flex-wrap: wrap;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
    position: relative;
}

.stat-card h3 {
    font-size: 2rem;
    margin: 0;
    color: #1a73e8;
}

.stat-card p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}

.stat-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 24px;
    opacity: 0.3;
}

.responses-grid {
    display: grid;
    gap: 20px;
}

.response-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    background: white;
}

.response-card.pending {
    border-left: 4px solid #ff9800;
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.email-info h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.email-meta {
    font-size: 14px;
    color: #666;
    margin: 0;
}

.confidence {
    font-weight: bold;
    color: #1a73e8;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-pending {
    background-color: #fff3e0;
    color: #f57c00;
}

.status-approved {
    background-color: #e8f5e8;
    color: #2e7d32;
}

.status-sent {
    background-color: #e3f2fd;
    color: #1976d2;
}

.status-rejected {
    background-color: #ffebee;
    color: #c62828;
}

.response-content {
    margin: 15px 0;
}

.response-content h5 {
    margin: 0 0 10px 0;
    color: #333;
}

.response-text {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    border-left: 4px solid #1a73e8;
    font-family: Georgia, serif;
    line-height: 1.6;
}

.response-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.original-email,
.reject-form {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.original-email h5,
.reject-form h5 {
    margin: 0 0 10px 0;
    color: #333;
}

.email-content {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 13px;
}

.reject-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
}

.reject-form .form-actions {
    display: flex;
    gap: 10px;
}

.tabs-container {
    margin: 30px 0 20px 0;
}

.tabs {
    display: flex;
    border-bottom: 2px solid #e0e0e0;
}

.tab-button {
    background: none;
    border: none;
    padding: 12px 24px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-button:hover {
    background-color: #f5f5f5;
}

.tab-button.active {
    color: #1a73e8;
    border-bottom-color: #1a73e8;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.table-container {
    overflow-x: auto;
}

.responses-table {
    width: 100%;
    border-collapse: collapse;
}

.responses-table th,
.responses-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.responses-table th {
    background-color: #f5f5f5;
    font-weight: 500;
    color: #333;
}

.email-subject {
    font-weight: 500;
    color: #333;
}

.email-intent {
    color: #666;
    font-style: italic;
}

.analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
}

.analysis-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    background: white;
}

.analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.analysis-header h4 {
    margin: 0;
    color: #333;
    font-size: 14px;
}

.confidence-score {
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.analysis-details p {
    margin: 5px 0;
    font-size: 13px;
    color: #666;
}

.decision {
    font-weight: 500;
}

.decision-respond {
    color: #2e7d32;
}

.decision-escalate {
    color: #f57c00;
}

.decision-ignore {
    color: #666;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
}

.empty-state h3 {
    color: #333;
    margin-bottom: 10px;
}
</style>
{% endblock %}