{% extends 'base.html' %}

{% block content %}
<!-- Error Messages with Better Styling -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }}" id="message-{{ forloop.counter }}">
            {{ message|safe }}
            {% if 'oauth_expired' in message.tags %}
                <br><a href="{% url 'connect_gmail' %}" class="btn btn-primary btn-sm mt-2">Reconnect Gmail</a>
            {% endif %}
            <button onclick="dismissMessage('message-{{ forloop.counter }}')" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
    {% endfor %}
{% endif %}

{% if not has_gmail %}
<div class="card text-center">
    <div class="card-body py-5">
        <i class="fas fa-envelope fa-4x text-primary mb-4"></i>
        <h2 class="card-title">Connect Your Gmail Account</h2>
        <p class="card-text text-muted mb-4">To view your emails, please connect your Gmail account using secure OAuth2 authentication.</p>
        <a href="{% url 'connect_gmail' %}" class="btn btn-success btn-lg">
            <i class="fab fa-google me-2"></i>Connect Gmail Account
        </a>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
            <div class="mb-3 mb-md-0">
                <h2 class="card-title mb-1">
                    <i class="fas fa-envelope text-primary me-2"></i>Your Gmail: {{ gmail_account.email }}
                </h2>
                <small class="text-muted">
                    <strong>Status:</strong> 
                    <span id="connection-status" class="text-success">
                        <i class="fas fa-check-circle me-1"></i>Connected
                    </span> | 
                    <strong>Last Updated:</strong> {{ gmail_account.updated_at|date:"M d, Y H:i" }}
                </small>
            </div>
            
            <div class="dashboard-actions">
                <a href="{% url 'sync_emails' %}" class="btn btn-primary" id="sync-btn">
                    <i class="fas fa-sync"></i>Sync Emails
                </a>
                <a href="{% url 'ai_config' %}" class="btn btn-secondary">
                    <i class="fas fa-robot"></i>AI Config
                </a>
                <a href="{% url 'ai_responses' %}" class="btn btn-info">
                    <i class="fas fa-paper-plane"></i>AI Responses
                </a>
                <button onclick="toggleLogs()" class="btn btn-outline-secondary">
                    <i class="fas fa-clipboard-list"></i>System Logs
                </button>
                <button onclick="confirmDisconnect()" class="btn btn-outline-danger">
                    <i class="fas fa-unlink"></i>Disconnect
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Logs Panel (Initially Hidden) -->
<div id="logs-panel" class="card" style="display: none;">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-clipboard-list me-2"></i>System Logs (Last 100 entries)
        </h5>
    </div>
    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
        <pre id="logs-content" class="small text-muted mb-0">Loading logs...</pre>
    </div>
    <div class="card-footer">
        <button onclick="refreshLogs()" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-sync me-1"></i>Refresh Logs
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header bg-light">
        <h3 class="mb-0">
            <i class="fas fa-inbox me-2"></i>Recent Emails ({{ emails.count }})
        </h3>
    </div>
    <div class="card-body p-0">
        {% if emails %}
            {% for email in emails %}
            <div class="email-item px-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="email-subject">
                            <a href="{% url 'email_detail' email.id %}" class="text-decoration-none">
                                {% if not email.is_read %}
                                    <i class="fas fa-circle text-primary me-2" style="font-size: 0.5rem;"></i>
                                {% endif %}
                                {{ email.subject|default:"(No Subject)" }}
                            </a>
                        </div>
                        <div class="email-meta">
                            <i class="fas fa-user me-1"></i><strong>From:</strong> {{ email.sender }}
                            {% if email.body_plain %}
                            <div class="mt-2 text-muted small">
                                {{ email.body_plain|truncatechars:120 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>{{ email.received_date|date:"M d, Y H:i" }}
                        </small>
                        {% if not email.is_read %}
                            <div class="mt-1">
                                <span class="badge bg-primary">UNREAD</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-3">No emails found.</p>
                <p class="text-muted">Click "Sync Emails" to fetch your latest emails.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function dismissMessage(messageId) {
    document.getElementById(messageId).style.display = 'none';
}

function toggleLogs() {
    const panel = document.getElementById('logs-panel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        refreshLogs();
    } else {
        panel.style.display = 'none';
    }
}

function refreshLogs() {
    fetch('/api/logs/')
        .then(response => response.json())
        .then(data => {
            const logsContent = document.getElementById('logs-content');
            if (data.success) {
                logsContent.textContent = data.logs.join('');
                logsContent.scrollTop = logsContent.scrollHeight;
            } else {
                logsContent.textContent = 'Error loading logs: ' + data.error;
            }
        })
        .catch(error => {
            document.getElementById('logs-content').textContent = 'Error fetching logs: ' + error;
        });
}

// Auto-hide success messages after 5 seconds
setTimeout(function() {
    const successMessages = document.querySelectorAll('.alert-success');
    successMessages.forEach(function(msg) {
        msg.style.transition = 'opacity 0.5s';
        msg.style.opacity = '0';
        setTimeout(() => msg.style.display = 'none', 500);
    });
}, 5000);

// Add loading state to sync button
document.addEventListener('DOMContentLoaded', function() {
    const syncBtn = document.getElementById('sync-btn');
    if (syncBtn) {
        syncBtn.addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
            this.style.pointerEvents = 'none';
        });
    }
});

// Confirm disconnect function
function confirmDisconnect() {
    if (confirm('Are you sure you want to disconnect your Gmail account?\n\nThis will delete all synced emails and you\'ll need to reconnect to access Gmail again.')) {
        window.location.href = "{% url 'disconnect_gmail' %}";
    }
}
</script>

{% endblock %}