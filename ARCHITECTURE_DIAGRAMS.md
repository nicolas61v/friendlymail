# ğŸ—ï¸ Diagrama de Arquitectura: FriendlyMail

## 1. Flujo General de la AplicaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRIENDLYMAIL                            â”‚
â”‚                                                                  â”‚
â”‚  Django Backend + Frontend                                      â”‚
â”‚  Database: SQLite3                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PUNTO DE ENTRADA                            â”‚
â”‚                                                                  â”‚
â”‚  1. Usuario inicia sesiÃ³n (Login/Register)                      â”‚
â”‚  2. Autentica con Django (username/password)                    â”‚
â”‚  3. Ve Dashboard                                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONECTAR CUENTA EMAIL                        â”‚
â”‚                                                                  â”‚
â”‚  /connect-gmail/ â†’ OAuth2 Google                                â”‚
â”‚      â†“                                                           â”‚
â”‚  Google Consent â†’ Autoriza FriendlyMail                         â”‚
â”‚      â†“                                                           â”‚
â”‚  /gmail/callback/ â†’ Recibe tokens                               â”‚
â”‚      â†“                                                           â”‚
â”‚  Guarda en EmailAccount + GmailAccount                          â”‚
â”‚                                                                  â”‚
â”‚  /connect-outlook/ â†’ OAuth2 Microsoft                           â”‚
â”‚      â†“                                                           â”‚
â”‚  Microsoft Consent â†’ Autoriza FriendlyMail                      â”‚
â”‚      â†“                                                           â”‚
â”‚  /outlook/callback/ â†’ Recibe tokens                             â”‚
â”‚      â†“                                                           â”‚
â”‚  Guarda en EmailAccount                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SINCRONIZAR EMAILS                             â”‚
â”‚                                                                  â”‚
â”‚  /sync-all/ o AutomÃ¡tico (cada 20 min)                          â”‚
â”‚      â†“                                                           â”‚
â”‚  Para cada EmailAccount:                                        â”‚
â”‚    â”œâ”€ GmailService.sync_emails(account_id)                      â”‚
â”‚    â”‚  â””â”€ Gmail API â†’ Ãšltimos 20 emails                          â”‚
â”‚    â”‚     â””â”€ Guarda en modelo Email                              â”‚
â”‚    â”‚                                                            â”‚
â”‚    â””â”€ OutlookService.sync_emails(account_id)                    â”‚
â”‚       â””â”€ Microsoft Graph API â†’ Ãšltimos 50 emails                â”‚
â”‚          â””â”€ Guarda en modelo Email                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               [OPCIONAL] PROCESAR CON IA                        â”‚
â”‚                                                                  â”‚
â”‚  Si AIContext.is_active = True:                                 â”‚
â”‚      â†“                                                           â”‚
â”‚  EmailAIProcessor.process_email()                               â”‚
â”‚      â†“                                                           â”‚
â”‚  Analiza con OpenAI GPT-4o-mini                                 â”‚
â”‚      â†“                                                           â”‚
â”‚  Crea: EmailIntent (tipo) + AIResponse (respuesta)              â”‚
â”‚      â†“                                                           â”‚
â”‚  Status: pending_approval                                       â”‚
â”‚      â†“                                                           â”‚
â”‚  Usuario aprueba/rechaza/edita                                  â”‚
â”‚      â†“                                                           â”‚
â”‚  GmailService.send_email() o descarta                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   VER EN DASHBOARD                              â”‚
â”‚                                                                  â”‚
â”‚  /dashboard/                                                    â”‚
â”‚      â†“                                                           â”‚
â”‚  Obtiene TODOS los emails de TODAS las cuentas                  â”‚
â”‚      â†“                                                           â”‚
â”‚  Agrupa por EmailAccount (estadÃ­sticas)                         â”‚
â”‚      â†“                                                           â”‚
â”‚  Ordena por fecha descendente                                   â”‚
â”‚      â†“                                                           â”‚
â”‚  Muestra Ãºltimos 50 emails unificados                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ABRIR Y LEER EMAIL DETALLADO                       â”‚
â”‚                                                                  â”‚
â”‚  /email/{id}/ â† CORREGIDO                                       â”‚
â”‚      â†“                                                           â”‚
â”‚  Busca Email por ID:                                            â”‚
â”‚    1. En EmailAccount (nuevo) â† PRIMERO                         â”‚
â”‚    2. En GmailAccount (legacy) â† FALLBACK                       â”‚
â”‚      â†“                                                           â”‚
â”‚  Renderiza template con:                                        â”‚
â”‚    â”œâ”€ Subject, From, To, Date                                   â”‚
â”‚    â”œâ”€ HTML Body (si existe)                                     â”‚
â”‚    â””â”€ Plain Text Body (si existe)                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Modelo de Base de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        User (Django)           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)                       â”‚
â”‚  username                      â”‚
â”‚  email                         â”‚
â”‚  password_hash                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ 1:N
               â”‚
               â”œâ”€ GmailAccount (LEGACY)
               â”‚  â””â”€ OneToOne (DEPRECATED)
               â”‚
               â””â”€ EmailAccount (NUEVO) âœ…
                  â”‚
                  â”œâ”€ email
                  â”œâ”€ provider (gmail/outlook)
                  â”œâ”€ access_token
                  â”œâ”€ refresh_token
                  â”œâ”€ token_expires_at
                  â”œâ”€ is_active
                  â””â”€ unique_together(user, email, provider)
                     â”‚
                     â”œâ”€ 1:N Email
                     â”‚  â”œâ”€ provider_id
                     â”‚  â”œâ”€ subject
                     â”‚  â”œâ”€ sender
                     â”‚  â”œâ”€ recipient
                     â”‚  â”œâ”€ body_plain
                     â”‚  â”œâ”€ body_html
                     â”‚  â”œâ”€ received_date (indexed)
                     â”‚  â”œâ”€ is_read
                     â”‚  â”œâ”€ thread_id
                     â”‚  â””â”€ 1:1 EmailIntent (opcional)
                     â”‚     â”œâ”€ intent_type
                     â”‚     â”œâ”€ confidence_score
                     â”‚     â”œâ”€ ai_decision
                     â”‚     â””â”€ 1:1 AIResponse
                     â”‚        â”œâ”€ response_text
                     â”‚        â”œâ”€ response_subject
                     â”‚        â”œâ”€ status
                     â”‚        â””â”€ generated_at
                     â”‚
                     â””â”€ N:1 AIContext
                        â”œâ”€ role
                        â”œâ”€ context_description
                        â”œâ”€ can_respond_topics
                        â”œâ”€ cannot_respond_topics
                        â”œâ”€ auto_send
                        â””â”€ 1:N TemporalRule
                           â”œâ”€ name
                           â”œâ”€ keywords
                           â”œâ”€ response_template
                           â”œâ”€ start_date/end_date
                           â””â”€ status (draft/active/...)
```

---

## 3. Flujo de SincronizaciÃ³n de Emails

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Usuario hace click    â”‚
â”‚   "Sync Now" o cada 20min
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sync_all_accounts() [views.py:1060]                           â”‚
â”‚                                                                 â”‚
â”‚  email_accounts = EmailAccount.objects.filter(is_active=True)  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚          â”‚
   GMAIL â”‚          â”‚ OUTLOOK
        â”‚          â”‚
        â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚GMAIL LOOP     â”‚ â”‚OUTLOOK LOOP      â”‚
â”‚               â”‚ â”‚                  â”‚
â”‚for account in â”‚ â”‚for account in    â”‚
â”‚gmail_accounts:â”‚ â”‚outlook_accounts: â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚
        â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚GmailService     â”‚ â”‚OutlookService    â”‚
â”‚.sync_emails(    â”‚ â”‚.sync_emails(     â”‚
â”‚  account_id     â”‚ â”‚  max_results     â”‚
â”‚)                â”‚ â”‚)                 â”‚
â”‚                 â”‚ â”‚                  â”‚
â”‚âœ… NUEVO!        â”‚ â”‚                  â”‚
â”‚Sincroniza       â”‚ â”‚Sincroniza        â”‚
â”‚cuenta especÃ­ficaâ”‚ â”‚cuenta especÃ­fica â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â†“                   â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Gmail API v1              â”‚
    â”‚   GET /messages             â”‚
    â”‚   maxResults=20             â”‚
    â”‚                             â”‚
    â”‚   Microsoft Graph v1.0       â”‚
    â”‚   GET /me/messages          â”‚
    â”‚   maxResults=50             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“ (para cada mensaje)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Extrae:                  â”‚
    â”‚ â”œâ”€ Subject               â”‚
    â”‚ â”œâ”€ From                  â”‚
    â”‚ â”œâ”€ To                    â”‚
    â”‚ â”œâ”€ Date                  â”‚
    â”‚ â”œâ”€ Body (plain/html)     â”‚
    â”‚ â””â”€ Message ID            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Email.objects.           â”‚
    â”‚   update_or_create(      â”‚
    â”‚   email_account=account, â”‚
    â”‚   provider_id=msg_id,    â”‚
    â”‚   defaults={...}         â”‚
    â”‚ )                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Guardado en BD:          â”‚
    â”‚ - Email model            â”‚
    â”‚ - Asociado a EmailAccountâ”‚
    â”‚ - Listo para dashboard   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“ (si AIContext.is_active)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ [OPCIONAL] IA Processing â”‚
    â”‚ EmailAIProcessor         â”‚
    â”‚ .process_email()         â”‚
    â”‚                          â”‚
    â”‚ Crea:                    â”‚
    â”‚ - EmailIntent            â”‚
    â”‚ - AIResponse             â”‚
    â”‚ Status: pending_approval â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Retorna lista de         â”‚
    â”‚ emails sincronizados     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Flujo de Email Detail (CORREGIDO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario hace click en email    â”‚
â”‚ /email/{email_id}/             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ email_detail(request, email_id)        â”‚
â”‚ [views.py:329] âœ… CORREGIDO            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Paso 1: Busca en   â”‚
    â”‚ EmailAccount       â”‚
    â”‚ (modelo NUEVO)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚
    SÃâ”‚             â”‚NO
      â†“             â†“
  âœ…FOUND      Paso 2: Busca en
     â”‚         GmailAccount
     â”‚         (modelo LEGACY)
     â”‚              â”‚
     â”‚        â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
     â”‚        â”‚          â”‚
     â”‚      SÃâ”‚          â”‚NO
     â”‚        â†“          â†“
     â”‚      âœ…FOUND   âŒNOT FOUND
     â”‚        â”‚          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Renderiza template: â”‚
    â”‚ email_detail.html   â”‚
    â”‚                     â”‚
    â”‚ Muestra:            â”‚
    â”‚ â”œâ”€ From             â”‚
    â”‚ â”œâ”€ To               â”‚
    â”‚ â”œâ”€ Date             â”‚
    â”‚ â”œâ”€ Subject          â”‚
    â”‚ â”œâ”€ HTML Body        â”‚
    â”‚ â””â”€ Plain Text Body  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Flujo de MÃºltiples Cuentas Gmail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario conecta 2 cuentas Gmail           â”‚
â”‚                                            â”‚
â”‚  1. trabajo@gmail.com                      â”‚
â”‚  2. personal@gmail.com                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ambas se guardan en EmailAccount:         â”‚
â”‚                                            â”‚
â”‚  EmailAccount #5:                          â”‚
â”‚  â”œâ”€ user_id: 1                             â”‚
â”‚  â”œâ”€ email: trabajo@gmail.com               â”‚
â”‚  â”œâ”€ provider: gmail                        â”‚
â”‚  â””â”€ tokens...                              â”‚
â”‚                                            â”‚
â”‚  EmailAccount #6:                          â”‚
â”‚  â”œâ”€ user_id: 1                             â”‚
â”‚  â”œâ”€ email: personal@gmail.com              â”‚
â”‚  â”œâ”€ provider: gmail                        â”‚
â”‚  â””â”€ tokens...                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sync_all_accounts() itera AMBAS           â”‚
â”‚  [views.py:1086]                           â”‚
â”‚                                            â”‚
â”‚  for account in email_accounts:            â”‚
â”‚    â”œâ”€ account #5: trabajo@gmail.com        â”‚
â”‚    â”‚  â””â”€ sync_emails(email_account_id=5)   â”‚
â”‚    â”‚     â””â”€ Sincroniza trabajo            â”‚
â”‚    â”‚                                       â”‚
â”‚    â””â”€ account #6: personal@gmail.com       â”‚
â”‚       â””â”€ sync_emails(email_account_id=6)   â”‚
â”‚          â””â”€ Sincroniza personal           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resultado en BD:                          â”‚
â”‚                                            â”‚
â”‚  Email #100:                               â”‚
â”‚  â”œâ”€ email_account_id: 5 (trabajo)          â”‚
â”‚  â”œâ”€ subject: "Meeting at 3pm"              â”‚
â”‚  â””â”€ ...                                    â”‚
â”‚                                            â”‚
â”‚  Email #101:                               â”‚
â”‚  â”œâ”€ email_account_id: 5 (trabajo)          â”‚
â”‚  â”œâ”€ subject: "Budget review"               â”‚
â”‚  â””â”€ ...                                    â”‚
â”‚                                            â”‚
â”‚  Email #200:                               â”‚
â”‚  â”œâ”€ email_account_id: 6 (personal)         â”‚
â”‚  â”œâ”€ subject: "Dinner tomorrow?"            â”‚
â”‚  â””â”€ ...                                    â”‚
â”‚                                            â”‚
â”‚  Email #201:                               â”‚
â”‚  â”œâ”€ email_account_id: 6 (personal)         â”‚
â”‚  â”œâ”€ subject: "Birthday party ğŸ‰"           â”‚
â”‚  â””â”€ ...                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard muestra TODOS unificados:       â”‚
â”‚                                            â”‚
â”‚  [Trabajo] Birthday party ğŸ‰               â”‚
â”‚  [Personal] Budget review                  â”‚
â”‚  [Work] Dinner tomorrow?                   â”‚
â”‚  [Personal] Meeting at 3pm                 â”‚
â”‚                                            â”‚
â”‚  (Ordenados por fecha descendente)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Componentes Principales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRIENDLYMAIL COMPONENTS                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Templates (HTML) â”‚
â”‚  â”œâ”€ login.html   â”‚
â”‚  â”œâ”€ dashboard.html
â”‚  â”œâ”€ email_detail.html
â”‚  â”œâ”€ ai_responses.html
â”‚  â””â”€ ai_config_simple.html
â”‚                  â”‚
â”‚ Static (CSS/JS)  â”‚
â”‚  â””â”€ Bootstrap    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP Request/Response
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Django Backend                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  urls.py â†’ Route requests               â”‚
â”‚     â†“                                   â”‚
â”‚  views.py â†’ Handle logic                â”‚
â”‚     â”œâ”€ email_detail() [FIXED]           â”‚
â”‚     â”œâ”€ sync_all_accounts() [FIXED]      â”‚
â”‚     â”œâ”€ dashboard()                      â”‚
â”‚     â””â”€ ... (50+ views)                  â”‚
â”‚     â†“                                   â”‚
â”‚  models.py â†’ Define schema              â”‚
â”‚     â”œâ”€ EmailAccount                     â”‚
â”‚     â”œâ”€ Email                            â”‚
â”‚     â”œâ”€ EmailIntent                      â”‚
â”‚     â””â”€ AIResponse                       â”‚
â”‚     â†“                                   â”‚
â”‚  Services:                              â”‚
â”‚     â”œâ”€ gmail_service.py [FIXED]         â”‚
â”‚     â”‚  â””â”€ GmailService                  â”‚
â”‚     â”‚     â””â”€ sync_emails()              â”‚
â”‚     â”‚                                   â”‚
â”‚     â”œâ”€ outlook_service.py               â”‚
â”‚     â”‚  â””â”€ OutlookService                â”‚
â”‚     â”‚                                   â”‚
â”‚     â””â”€ ai_service.py                    â”‚
â”‚        â””â”€ EmailAIProcessor              â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
      â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                   â”‚
      â†“                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Integrations   â”‚              â”‚ Data Layer     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Gmail API      â”‚              â”‚ SQLite DB      â”‚
â”‚ Google OAuth2  â”‚              â”‚                â”‚
â”‚                â”‚              â”‚ Tables:        â”‚
â”‚ Microsoft      â”‚              â”‚  - User        â”‚
â”‚ Graph API      â”‚              â”‚  - EmailAccountâ”‚
â”‚ Outlook OAuth2 â”‚              â”‚  - Email       â”‚
â”‚                â”‚              â”‚  - AIContext   â”‚
â”‚ OpenAI API     â”‚              â”‚  - EmailIntent â”‚
â”‚ GPT-4o-mini    â”‚              â”‚  - AIResponse  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  - TemporalRule
                                â”‚ indexes (perf)â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Flujo de Respuesta con IA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Email sincronizado con IA â”‚
â”‚ habilitada                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EmailAIProcessor.process_email()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EnvÃ­a a OpenAI API:          â”‚
â”‚                              â”‚
â”‚ System prompt: AIContext     â”‚
â”‚ + TemporalRules             â”‚
â”‚ + Email content             â”‚
â”‚                              â”‚
â”‚ Responde:                    â”‚
â”‚ - Intent type (academic...) â”‚
â”‚ - Confidence score          â”‚
â”‚ - Suggested response        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Crea en BD:                  â”‚
â”‚                              â”‚
â”‚ EmailIntent #42:             â”‚
â”‚ â”œâ”€ email_id: 100            â”‚
â”‚ â”œâ”€ intent_type: academic_q  â”‚
â”‚ â”œâ”€ confidence: 0.95          â”‚
â”‚ â””â”€ ai_decision: respond      â”‚
â”‚                              â”‚
â”‚ AIResponse #42:              â”‚
â”‚ â”œâ”€ email_intent_id: 42      â”‚
â”‚ â”œâ”€ response_text: "..."      â”‚
â”‚ â”œâ”€ response_subject: "Re: ..."
â”‚ â”œâ”€ status: pending_approval  â”‚
â”‚ â””â”€ generated_at: now()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario ve en:               â”‚
â”‚ /ai-responses/               â”‚
â”‚                              â”‚
â”‚ Tab "Pending Approval":      â”‚
â”‚ â”œâ”€ Email subject             â”‚
â”‚ â”œâ”€ Suggested response        â”‚
â”‚ â”œâ”€ [Approve] button          â”‚
â”‚ â”œâ”€ [Reject] button           â”‚
â”‚ â””â”€ Edit text field           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
        â”‚            â”‚
    Approve       Reject
        â”‚            â”‚
        â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Approve:    â”‚ â”‚ Reject:  â”‚
â”‚ Statusâ†’sent â”‚ â”‚ Statusâ†’  â”‚
â”‚ Send via    â”‚ â”‚rejected  â”‚
â”‚ Gmail API   â”‚ â”‚ (ignore) â”‚
â”‚ Successâ†’âœ…  â”‚ â”‚          â”‚
â”‚ Failureâ†’âš ï¸  â”‚ â”‚ Feedback â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ optional â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Diagrama de Estados (Email)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  GMAIL/OUTLOOK   â”‚
                    â”‚     API          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  sync_emails()   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Email CREATED in DB â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                â”‚ status: (no status) â”‚
                â”‚ is_read: true/false â”‚
                â”‚ email_account_id: X â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚
                NO AI         AI ENABLED
                    â”‚            â”‚
                    â”‚            â†“
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   â”‚  process_email â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚            â”‚
                    â”‚            â†“
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   â”‚ EmailIntent CREATED    â”‚
                    â”‚   â”‚ AIResponse CREATED     â”‚
                    â”‚   â”‚ Status: pending_approv â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚            â”‚
                    â”‚            â”œâ”€â”€â”€â”€â”€Approveâ”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚                   â”‚
                    â”‚            â†“                   â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚   â”‚ GmailService.send() â”‚  â”‚
                    â”‚   â”‚ Status: approved    â”‚  â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚            â”‚                 â”‚
                    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”          â”‚
                    â”‚     â”‚             â”‚          â”‚
                    â”‚  Success      Failure       â”‚
                    â”‚     â”‚             â”‚         â”‚
                    â”‚     â†“             â†“         â”‚
                    â”‚  Status:     Status:        â”‚
                    â”‚   sent       approved       â”‚
                    â”‚              (retry)        â”‚
                    â”‚                             â”‚
                    â”‚     â”Œâ”€â”€â”€â”€â”€â”€Rejectâ”€â”€â”€â”€â”€â”    â”‚
                    â”‚     â”‚                  â”‚    â”‚
                    â”‚     â†“                  â†“    â”‚
                    â”‚  Status:          Status:   â”‚
                    â”‚  rejected         (legacy)  â”‚
                    â”‚                             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â†“
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Dashboard shows    â”‚
                      â”‚ (user sees email)  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Ãndices de Base de Datos (Performance)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               DATABASE INDEXES                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Email.received_date
â”œâ”€ Usado en: dashboard(), sorting
â”œâ”€ Tipo: DateTimeField con db_index=True
â””â”€ Beneficio: O(log n) vs O(n) para Ãºltimos 50 emails

Email.[email_account, provider_id]
â”œâ”€ Usado en: update_or_create() durante sync
â”œâ”€ Tipo: Composite Index
â””â”€ Beneficio: RÃ¡pidamente evita duplicados

EmailAccount.unique_together(user, email, provider)
â”œâ”€ Previene: Duplicados de cuentas
â”œâ”€ Ejemplo: No puedes tener trabajo@gmail.com 2 veces
â””â”€ Beneficio: Integridad de datos

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resultado: 1000 emails = <1ms queries             â”‚
â”‚  Resultado: 10000 emails = <5ms queries            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Flujo de Scheduler (Auto-Sync)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Django App Starts           â”‚
â”‚  (runserver / production)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCHEDULER_AUTOSTART=True   â”‚
â”‚  (settings.py)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  scheduler.py load          â”‚
â”‚  schedule_auto_sync()       â”‚
â”‚  add_job(                   â”‚
â”‚    auto_sync_emails,        â”‚
â”‚    'interval',              â”‚
â”‚    minutes=20               â”‚ â† AUTO_SYNC_INTERVAL
â”‚  )                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Timer: 20 minutes interval      â”‚
â”‚  runs in background thread       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      (each 20 min)
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auto_sync_emails()              â”‚
â”‚                                  â”‚
â”‚  for user in User.objects.all(): â”‚
â”‚    â”œâ”€ GmailService(user)         â”‚
â”‚    â”‚  â””â”€ sync_emails()           â”‚
â”‚    â”‚     â””â”€ Gmail API call       â”‚
â”‚    â”‚                             â”‚
â”‚    â””â”€ OutlookService(user)       â”‚
â”‚       â””â”€ sync_emails()           â”‚
â”‚          â””â”€ Microsoft API call   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Emails saved to DB              â”‚
â”‚  Logs written                    â”‚
â”‚  Notifications (if enabled)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
   (waits 20 more minutes...)
             â”‚
             â†“
        (repeats forever)
```

---

Estos diagramas proporcionan una visiÃ³n completa de cÃ³mo funciona FriendlyMail.

